<script>
  // ---- Firebase config ----
  const firebaseConfig = {
    apiKey: "AIzaSyDoBEl4U6y18gt8Aute2e3xVNZbo7Absj8",
    authDomain: "hog-social-398b6.firebaseapp.com",
    projectId: "hog-social-398b6",
    storageBucket: "hog-social-398b6.firebasestorage.app",
    messagingSenderId: "178343328232",
    appId: "1:178343328232:web:a629bdb1707b688f3ccc5d"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  auth.signInAnonymously();

  // ---- Variables ----
  let localUsername = "";

  // ---- Utility ----
  function escapeHtml(text) {
    const div = document.createElement("div");
    div.innerText = text;
    return div.innerHTML;
  }

  // ---- Update username from input ----
  document.getElementById('username').addEventListener('input', (e) => {
    localUsername = e.target.value.trim() || "Anonymous Hog";
  });

  // ---- Notifications ----
  function sendNotification(targetUser, message) {
    if (!targetUser) return;
    const notifRef = db.collection("notifications").doc(targetUser).collection("userNotifications");
    notifRef.add({
      message: message,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).catch(err => console.error("Notification send error:", err));
  }

  function listenForNotifications(usernameToListen) {
    if (!usernameToListen) return;
    const notifRef = db.collection("notifications").doc(usernameToListen).collection("userNotifications");

    if (window._hog_notif_unsub) {
      try { window._hog_notif_unsub(); } catch(e) {}
      window._hog_notif_unsub = null;
    }

    window._hog_notif_unsub = notifRef.orderBy("timestamp", "desc").onSnapshot(snapshot => {
      const notifPanel = document.getElementById("notificationPanel");
      const notifCount = document.getElementById("notifCount");
      notifPanel.innerHTML = "";
      let count = 0;
      snapshot.forEach(doc => {
        const d = doc.data();
        const dateStr = d.timestamp ? d.timestamp.toDate().toLocaleString() : "";
        const item = document.createElement("div");
        item.style.padding = "8px";
        item.style.borderBottom = "1px solid #eee";
        item.innerHTML = `<div>${escapeHtml(d.message)}</div><div style="font-size:12px;color:#666">${dateStr}</div>`;
        notifPanel.appendChild(item);
        count++;
      });
      if (count > 0) {
        notifCount.style.display = "inline-block";
        notifCount.textContent = count;
      } else {
        notifCount.style.display = "none";
        notifCount.textContent = "";
      }
    }, err => console.error("Notif listen error:", err));
  }

  document.getElementById("notificationBell").onclick = () => {
    const panel = document.getElementById("notificationPanel");
    panel.style.display = panel.style.display === "block" ? "none" : "block";
  };

  // ---- Posting ----
  function addPost() {
    const text = document.getElementById('postBox').value;
    if (!text.trim()) return;

    const user = localUsername || "Anonymous Hog";

    db.collection("posts").add({
      user: user,
      text: text,
      oinks: 0,
      boars: 0,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    })
    .then(() => {
      document.getElementById('postBox').value = "";

      // Notify other users
      db.collection("users").get()
        .then(snapshot => {
          snapshot.forEach(uDoc => {
            const target = uDoc.id;
            if (target && target !== user) {
              sendNotification(target, `${user} posted something new in the Trough! ðŸ–`);
            }
          });
        }).catch(err => console.error("Notification error:", err));
    })
    .catch(err => console.error("Add post error:", err));
  }

  // ---- Oink / Boar ----
  function oink(id, currentOinks) {
    const postRef = db.collection("posts").doc(id);
    postRef.get().then(doc => {
      if (!doc.exists) return;
      const data = doc.data();
      const owner = data.user;

      postRef.update({ oinks: (currentOinks || 0) + 1 })
        .then(() => {
          if (owner) sendNotification(owner, `${localUsername || 'Someone'} oinked your post! ðŸ·`);
        });
    }).catch(err => console.error("Oink error:", err));
  }

  function boar(id, currentBoars) {
    const postRef = db.collection("posts").doc(id);
    postRef.get().then(doc => {
      if (!doc.exists) return;
      const data = doc.data();
      const owner = data.user;

      postRef.update({ boars: (currentBoars || 0) + 1 })
        .then(() => {
          if (owner) sendNotification(owner, `${localUsername || 'Someone'} boared your post! ðŸ—`);
        });
    }).catch(err => console.error("Boar error:", err));
  }

  // ---- Display Feed ----
  db.collection("posts")
    .orderBy("createdAt", "desc")
    .onSnapshot(snapshot => {
      const feed = document.getElementById('feed');
      feed.innerHTML = "";

      snapshot.forEach(doc => {
        const post = doc.data();
        const postId = doc.id;

        let timeStr = "";
        try {
          if (post.createdAt) timeStr = post.createdAt.toDate().toLocaleString();
        } catch(e) { timeStr = ""; }

        feed.innerHTML += `
          <div class="post">
            <strong>${escapeHtml(post.user || 'Anonymous Hog')}</strong><br>
            <div>${escapeHtml(post.text || '')}</div>
            <div style="margin-top:6px; font-size:12px; color:#555;">${timeStr}</div>
            <div style="margin-top:8px;">
              <span class="oink" onclick="oink('${postId}', ${post.oinks || 0})" ti

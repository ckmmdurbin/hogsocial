<!DOCTYPE html>
<html>
<head>
  <title>üê∑ Hog Social üê∑</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <style>
    body {
      background-color: #ffd6e6;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1, h2 { text-align: center; }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 16px;
    }
    button {
      background-color: #8b5e3c;
      color: white;
      padding: 10px;
      border: none;
      margin-top: 10px;
      border-radius: 10px;
      cursor: pointer;
    }
    .post {
      background: white;
      margin-top: 15px;
      padding: 10px;
      border-radius: 10px;
    }
    .oink {
      font-size: 18px;
      cursor: pointer;
      margin-top: 5px;
    }
    .reply {
      background: #ffe6f0; /* Soft pink for replies */
      margin-left: 20px;
      margin-top: 6px;
      padding: 6px;
      border-radius: 8px;
    }
    #notificationPanel {
      display: none;
      position: fixed;
      top: 50px;
      right: 10px;
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      width: 300px;
      max-height: 350px;
      overflow: auto;
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    }
    #notificationBell {
      cursor: pointer;
      position: fixed;
      top: 10px;
      right: 10px;
      font-size: 22px;
    }
    #notifCount {
      display: none;
      font-size: 12px;
      color: white;
      background: red;
      border-radius: 10px;
      padding: 1px 6px;
    }
    .topHog {
      background: #ffb3cc; /* Soft pink for TOP HOG */
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 10px;
      text-align: center;
      font-weight: bold;
    }
    .replyBox {
      margin-left: 20px;
      margin-top: 5px;
    }
    .replyBox input {
      padding: 6px;
      margin-right: 5px;
      font-size: 14px;
    }
    .replyBox .replyUser {
      width: 25%;
    }
    .replyBox .replyText {
      width: 65%;
    }
    .replyBox button {
      padding: 6px 10px;
      font-size: 14px;
    }
  </style>
</head>
<body>

<div id="notificationBell">üîî <span id="notifCount"></span></div>
<div id="notificationPanel"></div>

<h1>üê∑ Hog Social</h1>
<h2>The Trough</h2>

<input id="username" placeholder="Your hog name..." />
<textarea id="postBox" placeholder="Drop slop in the trough..."></textarea>
<button onclick="addPost()">Post to the Trough</button>

<div class="topHog" id="topHog">TOP HOG: Loading...</div>

<div id="feed"></div>

<script>
  // ---- Firebase config ----
  const firebaseConfig = {
    apiKey: "AIzaSyDoBEl4U6y18gt8Aute2e3xVNZbo7Absj8",
    authDomain: "hog-social-398b6.firebaseapp.com",
    projectId: "hog-social-398b6",
    storageBucket: "hog-social-398b6.firebasestorage.app",
    messagingSenderId: "178343328232",
    appId: "1:178343328232:web:a629bdb1707b688f3ccc5d"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  auth.signInAnonymously();

  let localUsername = "";

  document.getElementById('username').addEventListener('input', (e) => {
    localUsername = e.target.value.trim() || "Anonymous Hog";
  });

  function escapeHtml(text) {
    const div = document.createElement("div");
    div.innerText = text;
    return div.innerHTML;
  }

  // ---- Notifications ----
  function sendNotification(targetUser, message) {
    if (!targetUser) return;
    const notifRef = db.collection("notifications").doc(targetUser).collection("userNotifications");
    notifRef.add({
      message: message,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).catch(err => console.error("Notification send error:", err));
  }

  function listenForNotifications(usernameToListen) {
    if (!usernameToListen) return;
    const notifRef = db.collection("notifications").doc(usernameToListen).collection("userNotifications");

    if (window._hog_notif_unsub) {
      try { window._hog_notif_unsub(); } catch(e) {}
      window._hog_notif_unsub = null;
    }

    window._hog_notif_unsub = notifRef.orderBy("timestamp", "desc").onSnapshot(snapshot => {
      const notifPanel = document.getElementById("notificationPanel");
      const notifCount = document.getElementById("notifCount");
      notifPanel.innerHTML = "";
      let count = 0;
      snapshot.forEach(doc => {
        const d = doc.data();
        const dateStr = d.timestamp ? d.timestamp.toDate().toLocaleString() : "";
        const item = document.createElement("div");
        item.style.padding = "8px";
        item.style.borderBottom = "1px solid #eee";
        item.innerHTML = `<div>${escapeHtml(d.message)}</div><div style="font-size:12px;color:#666">${dateStr}</div>`;
        notifPanel.appendChild(item);
        count++;
      });
      if (count > 0) {
        notifCount.style.display = "inline-block";
        notifCount.textContent = count;
      } else {
        notifCount.style.display = "none";
        notifCount.textContent = "";
      }
    }, err => console.error("Notif listen error:", err));
  }

  document.getElementById("notificationBell").onclick = () => {
    const panel = document.getElementById("notificationPanel");
    panel.style.display = panel.style.display === "block" ? "none" : "block";
  };

  // ---- Post Functions ----
  function addPost() {
    const text = document.getElementById('postBox').value;
    if (!text.trim()) return;
    const user = localUsername || "Anonymous Hog";

    db.collection("posts").add({
      user: user,
      text: text,
      oinks: 0,
      boars: 0,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    })
    .then(() => {
      document.getElementById('postBox').value = "";
      updateTopHog();
      db.collection("users").get()
        .then(snapshot => {
          snapshot.forEach(uDoc => {
            const target = uDoc.id;
            if (target && target !== user) {
              sendNotification(target, `${user} posted something new in the Trough! üêñ`);
            }
          });
        }).catch(err => console.error("Notification error:", err));
    })
    .catch(err => console.error("Add post error:", err));
  }

  function oink(id, currentOinks) {
    const postRef = db.collection("posts").doc(id);
    postRef.get().then(doc => {
      if (!doc.exists) return;
      const data = doc.data();
      const owner = data.user;
      postRef.update({ oinks: (currentOinks || 0) + 1 })
        .then(() => {
          if (owner) sendNotification(owner, `${localUsername || 'Someone'} oinked your post! üê∑`);
          updateTopHog();
        });
    }).catch(err => console.error("Oink error:", err));
  }

  function boar(id, currentBoars) {
    const postRef = db.collection("posts").doc(id);
    postRef.get().then(doc => {
      if (!doc.exists) return;
      const data = doc.data();
      const owner = data.user;
      postRef.update({ boars: (currentBoars || 0) + 1 })
        .then(() => {
          if (owner) sendNotification(owner, `${localUsername || 'Someone'} boared your post! üêó`);
        });
    }).catch(err => console.error("Boar error:", err));
  }

  // ---- Replies ----
  function showReplyBox(postId) {
    const replyDiv = document.getElementById(`replyDiv-${postId}`);
    replyDiv.style.display = replyDiv.style.display === "block" ? "none" : "block";
  }

  function addReply(postId) {
    const userInput = document.getElementById(`replyUser-${postId}`);
    const textInput = document.getElementById(`replyInput-${postId}`);
    const replyUser = userInput.value.trim() || "Anonymous Hog";
    const text = textInput.value.trim();
    if (!text) return;

    db.collection("posts").doc(postId).collection("replies").add({
      user: replyUser,
      text: text,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    })
    .then(() => {
      textInput.value = "";
      userInput.value = "";

      db.collection("posts").doc(postId).get().then(doc => {
        if (doc.exists) {
          const owner = doc.data().user;
          if (owner && owner !== replyUser) {
            sendNotification(owner, `${replyUser} replied to your post! üêñ`);
          }
        }
      });
    })
    .catch(err => console.error("Add reply error:", err));
  }

  // ---- Display Feed & Replies ----
  function updateFeed() {
    db.collection("posts")
      .orderBy("createdAt", "desc")
      .onSnapshot(snapshot => {
        const feed = document.getElementById('feed');
        feed.innerHTML = "";

        snapshot.forEach(doc => {
          const post = doc.data();
          const postId = doc.id;

          let timeStr = "";
          try { if (post.createdAt) timeStr = post.createdAt.toDate().toLocaleString(); } catch(e) { timeStr = ""; }

          feed.innerHTML += `
            <div class="post">
              <strong>${escapeHtml(post.user || 'Anonymous Hog')}</strong><br>
              <div>${escapeHtml(post.text || '')}</div>
              <div style="margin-top:6px; font-size:12px; color:#555;">${timeStr}</div>
              <div style="margin-top:8px;">
                <span class="oink" onclick="oink('${postId}', ${post.oinks || 0})" title="Oink (upvote)">
                  üê∑ ${post.oinks || 0} oinks
                </span>
                &nbsp;&nbsp;
                <span class="oink" onclick="boar('${postId}', ${post.boars || 0})" title="Boar (downvote)">
                  üêó ${post.boars || 0} boars
                </span>
                &nbsp;&nbsp;
                <button onclick="showReplyBox('${postId}')">Reply</button>
              </div>
              <div id="replyDiv-${postId}" class="replyBox" style="display:none;">
                <input id="replyUser-${postId}" class="replyUser" placeholder="Your hog name" />
                <input id="replyInput-${postId}" class="replyText" placeholder="Write a reply..." />
                <button onclick="addReply('${postId}')">Send</button>
              </div>
              <div id="replies-${postId}"></div>
            </div>
          `;

          // ---- Real-time replies ----
          db.collection("posts").doc(postId).collection("replies")
            .orderBy("createdAt", "asc")
            .onSnapshot(replySnapshot => {
              const replyDiv = document.getElementById(`replies-${postId}`);
              replyDiv.innerHTML = "";
              replySnapshot.forEach(rDoc => {
                const r = rDoc.data();
                let rTime = "";
                try { if (r.createdAt) rTime = r.createdAt.toDate().toLocaleString(); } catch(e) {}
                replyDiv.innerHTML += `
                  <div class="reply">
                    <strong>${escapeHtml(r.user || 'Anonymous Hog')}</strong>: ${escapeHtml(r.text)}<br>
                    <span style="font-size:11px; color:#666;">${rTime}</span>
                  </div>
                `;
              });
            });
        });
        updateTopHog();
      });
  }

  // ---- Top Hog ----
  function updateTopHog() {
    db.collection("posts")
      .get()
      .then(snapshot => {
        const scores = {};
        snapshot.forEach(doc => {
          const p = doc.data();
          const u = p.user || "Anonymous Hog";
          scores[u] = (scores[u] || 0) + (p.oinks || 0);
        });
        let topUser = "No posts yet";
        let maxOinks = 0;
        for (const [user, score] of Object.entries(scores)) {
          if (score > maxOinks) {
            maxOinks = score;
            topUser = user;
          }
        }
        document.getElementById('topHog').textContent = `TOP HOG: ${topUser} (${maxOinks} oinks)`;
      });
  }

  // ---- Initialize ----
  updateFeed();
  listenForNotifications(localUsername);
</script>

</body>
</html>
